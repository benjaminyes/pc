<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PrivateMail Terminal</title>
<style>
body {
  background: black;
  color: #00ff00;
  font-family: monospace;
  margin: 0;
}
#terminal {
  height: 100vh;
  overflow-y: auto;
  padding: 10px;
  white-space: pre-wrap;
}
#input {
  width: 100%;
  background: black;
  color: #00ff00;
  border: none;
  outline: none;
  font-family: monospace;
  font-size: 14px;
}
</style>
</head>
<body>

<div id="terminal"></div>
<input id="input" autofocus placeholder="type command..." />

<script>
const terminal = document.getElementById("terminal");
const input = document.getElementById("input");

const WS = new WebSocket("wss://morning-queen-9aca.benjamin-orian.workers.dev");

let username = null;
let currentThread = null;

function log(text) {
  terminal.textContent += text + "\n";
  terminal.scrollTop = terminal.scrollHeight;
}

// ✅ LIVE PUSH MESSAGES
WS.onmessage = e => {
  const msg = JSON.parse(e.data);

  if (msg.type === "system") log(msg.text);

  if (msg.type === "thread_created") {
    currentThread = msg.id;
    log("thread opened " + msg.id);
  }

  if (msg.type === "new_message") {
    if (!currentThread || currentThread === msg.thread) {
      log(`[${msg.message.from}] ${msg.message.data}`);
    }
  }

  if (msg.type === "search_results") {
    msg.results.forEach(u => {
      log(`${u.name} ${u.online ? "[online]" : ""} ${u.active48 ? "[active]" : ""}`);
    });
  }

  if (msg.type === "error") {
    log("ERROR: " + msg.error);
  }
};

// ✅ COMMAND PARSER
input.addEventListener("keydown", e => {
  if (e.key !== "Enter") return;

  const text = input.value.trim();
  input.value = "";

  if (!text) return;

  log("> " + text);
  const parts = text.split(" ");
  const cmd = parts.shift();

  // LOGIN
  if (cmd === "login") {
    username = parts[0];
    WS.send(JSON.stringify({ type: "register", name: username }));
    return;
  }

  // SEARCH USERS
  if (cmd === "search") {
    WS.send(JSON.stringify({ type: "search_users", query: parts.join(" ") }));
    return;
  }

  // OPEN THREAD
  if (cmd === "open") {
    WS.send(JSON.stringify({
      type: "create_thread",
      recipients: [username, parts[0]]
    }));
    return;
  }

  // SEND MESSAGE
  if (cmd === "msg") {
    if (!currentThread) return log("no thread open");

    WS.send(JSON.stringify({
      type: "thread_message",
      thread: currentThread,
      from: username,
      data: parts.join(" ")
    }));
    return;
  }

  log("Unknown command");
});

log("commands: login <name>, search <user>, open <user>, msg <text>");
</script>

</body>
</html>
