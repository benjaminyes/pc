<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PrivateMail Terminal</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');
body{
  background:black;
  color:#00ff88;
  font-family:'JetBrains Mono', monospace;
}
#terminal{
  max-width:900px;
  margin:auto;
  padding:15px;
  height:95vh;
  display:flex;
  flex-direction:column;
}
#line{
  flex:1;
  overflow-y:auto;
  white-space:pre-wrap;
}
.cursor{animation:blink 1s infinite;}
@keyframes blink{50%{opacity:0}}
input{
  background:black;
  color:#00ff88;
  border:none;
  outline:none;
  width:100%;
}
button{display:none}
.msg{color:#00ffaa}
.sys{color:#888}
.user{color:#33ffcc}
</style>
</head>
<body>

<div id="terminal">
<div id="line"></div>
<input id="cmd" autocomplete="off" placeholder="type command...">
</div>

<script>
const WS = new WebSocket("wss://morning-queen-9aca.benjamin-orian.workers.dev/");
const term = document.getElementById("line");
const cmd = document.getElementById("cmd");

let user=null, thread=null;

const print = (txt,cls="")=>{
  const d=document.createElement("div");
  d.className=cls;
  d.textContent=txt;
  term.appendChild(d);
  term.scrollTop=term.scrollHeight;
};

print("PrivateMail v1.0");
print("commands: login <name>, search <user>, msg <text>", "sys");

WS.onmessage = e=>{
 const m = JSON.parse(e.data);

 if(m.type==="registered") print(`logged in as ${user}`,"sys");
 if(m.type==="search_results"){
   m.results.forEach(u=>print(`${u.name} ${u.online?"[online]":""}`,"sys"));
 }
 if(m.type==="thread_created"){
   thread=m.id;
   print(`thread opened ${m.id}`,"sys");
 }
 if(m.type==="inbox"){
   print(`[${m.message.from}] ${m.message.data}`,"msg");
 }
};

cmd.addEventListener("keydown",e=>{
 if(e.key==="Enter"){
  run(cmd.value);
  cmd.value="";
 }
});

function run(s){
 let p=s.split(" ");
 let c=p.shift();

 if(c==="login"){
   if(!p[0]) return print("username required","sys");
   user = p[0];
   WS.send(JSON.stringify({type:"register", name:user}));
 }

 if(c==="search"){
   WS.send(JSON.stringify({type:"search_users", query:p[0]}));
 }

 if(c==="open"){
   if(!p[0]) return print("username required","sys");
   WS.send(JSON.stringify({
     type:"create_thread",
     recipients:[user, p[0]]
   }));
 }

 if(c==="msg"){
   if(!thread) return print("no thread open","sys");
   WS.send(JSON.stringify({
     type:"thread_message",
     thread,
     from:user,
     data:p.join(" ")
   }));
 }
}
</script>
</body>
</html>
