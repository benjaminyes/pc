<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PrivateMail</title>
<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  display: flex;
  height: 100vh;
  background: #1e1f22;
  color: #dcddde;
  font-family: system-ui;
}

/* SERVER BAR */
#servers {
  width: 70px;
  background: #111214;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.server {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: #5865f2;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}
.server:hover { border-radius: 35%; }

/* CHANNEL LIST */
#channels {
  width: 240px;
  background: #2b2d31;
  padding: 10px;
}

/* MAIN CHAT */
#main {
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* HEADER */
#header {
  background: #313338;
  padding: 10px;
}

/* MESSAGES */
#chat {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
}
.msg {
  margin-bottom: 6px;
}
.user { color: #4fd58f; }

/* INPUT */
#inputBar {
  background: #383a40;
  padding: 10px;
}
#input {
  width: 100%;
  background: #404249;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px;
}

/* USERS */
#users {
  width: 200px;
  background: #2b2d31;
  padding: 10px;
  overflow-y: auto;
}

/* LOGIN */
#login {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.9);
  display: flex;
  align-items: center;
  justify-content: center;
}
#loginBox {
  background: #2b2d31;
  padding: 20px;
}
</style>
</head>

<body>

<div id="login">
  <div id="loginBox">
    <input id="username" placeholder="Username">
    <button onclick="login()">Enter</button>
  </div>
</div>

<div id="servers">
  <div class="server" onclick="openGlobal()">üåç</div>
</div>

<div id="channels">
  <h3>Direct Messages</h3>
  <div id="threads"></div>
</div>

<div id="main">
  <div id="header"></div>
  <div id="chat"></div>
  <div id="inputBar">
    <input id="input" placeholder="Message...">
  </div>
</div>

<div id="users"></div>

<script>
const WS = new WebSocket("wss://morning-queen-9aca.benjamin-orian.workers.dev");

const GLOBAL = "global";
let username = null;
let currentThread = GLOBAL;
let threads = {[GLOBAL]: []};

const chat = document.getElementById("chat");
const header = document.getElementById("header");
const threadList = document.getElementById("threads");
const usersDiv = document.getElementById("users");
const loginBox = document.getElementById("login");

// RECEIVE EVENTS
WS.onmessage = e => {
  const msg = JSON.parse(e.data);

  if (msg.type === "thread_created") {
    threads[msg.id] ??= [];
    renderThreads();
  }

  if (msg.type === "new_message") {
    threads[msg.thread] ??= [];
    threads[msg.thread].push(msg.message);
    if (msg.thread === currentThread) renderChat();
  }

  if (msg.type === "search_results") {
    usersDiv.innerHTML = "<b>Online Users</b>";
    msg.results.forEach(u => {
      const d = document.createElement("div");
      d.textContent = u.name + (u.online ? " ‚óè" : "");
      d.onclick = () => openDM(u.name);
      usersDiv.appendChild(d);
    });
  }
};

function login() {
  username = document.getElementById("username").value;
  WS.send(JSON.stringify({ type: "register", name: username }));
  loginBox.style.display = "none";
  WS.send(JSON.stringify({ type: "search_users", query: "" }));
  openGlobal();
}

function openGlobal() {
  currentThread = GLOBAL; renderChat();
}

function openDM(user) {
  WS.send(JSON.stringify({ type: "create_thread", recipients: [username, user] }));
}

document.getElementById("input").onkeydown = e => {
  if (e.key !== "Enter") return;

  WS.send(JSON.stringify({
    type: "thread_message",
    thread: currentThread,
    from: username,
    data: e.target.value
  }));

  e.target.value = "";
};

function renderThreads() {
  threadList.innerHTML = "";
  for (const id in threads) {
    if (id === GLOBAL) continue;
    const d = document.createElement("div");
    d.textContent = "DM " + id.slice(0,6);
    d.onclick = () => {currentThread = id; renderChat()};
    threadList.appendChild(d);
  }
}

function renderChat() {
  header.textContent = currentThread === GLOBAL ? "üåç Global Chat" : "DM Thread";
  chat.innerHTML = "";
  (threads[currentThread] || []).forEach(m => {
    const d = document.createElement("div");
    d.className = "msg";
    d.innerHTML = `<span class="user">${m.from}</span> ${m.data}`;
    chat.appendChild(d);
  });
}

// AUTO SEARCH USERS
setInterval(() => {
  WS.send(JSON.stringify({ type: "search_users", query: "" }));
}, 4000);
</script>

</body>
</html>
